<html>
<head>
	<meta name="viewport" content="width=100%, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
	<title>Upload arduino control panel.</title>
<style>
.info{padding:13px;}
</style>
</head>

<body>

<script>
//
var rd = null;
//
if (window.File && window.FileReader && window.FileList && window.Blob) {
	rd = new FileReader();
} 
else {
	console.warn("Outdated browser!");
}
//
function urlencode(text) {
    var tmp = encodeURIComponent( text );
    tmp = tmp.replace(new RegExp('[*]', 'g'), '%2A');
    return tmp;
}
//
function loadFile(fp) {
	console.info("loadFile() started...",fp);
	document.querySelector("div.logfield > label").innerText = "Please wait 1 / 4 ...";
	var out=null;
	if(rd!=null && fp.files && fp.files[0]) {
		rd.onload = function(e) {
			out = e.target.result;
			console.info("Got file: ",out);
			document.querySelector("div.info").innerText += "1.) Got file, size: "+out.length+"\n";
			//
	        if(!out.match(/.*\<\/arduino\>.*/i)) {
				alert("Control panel should contain arduino configuration in JSON format and inside of <arduino>(json)</arduino> html block.");
		        document.location.href=document.location.href;
				return false;
			}
			
			//
			var atmp=out.split("<\/arduino\>");
			if( atmp.length!=2 ) {
				alert("Something went wrong. After parsing array should contain 2 values but there are "+atmp.length);
				document.location.href=document.location.href;
				return false;
			}
			
			var upc = atmp[0].substr(9,atmp[0].length);
			var up  = atmp[1];
			
			document.querySelector("div.logfield > label").innerText = "Please wait 2 / 4 ...";
			document.querySelector("div.info").innerText += "2.) Successful parsing uploaded file\n";
			
			//
			fetch(document.location.origin+"/upc=true", {  
			    method :'POST',  
			    headers:{"Content-type": "application/x-www-form-urlencoded; charset=UTF-8"},  
			    body   :urlencode(upc),
		    }).then(function (data1) {
		        console.info("returned data for upc: ",data1);
		        
		        document.querySelector("div.logfield > label").innerText = "Please wait 3 / 4 ...";
		        document.querySelector("div.info").innerText += "3.) Configuration looks good\n";
		        //
				fetch(document.location.origin+"/up=true", {  
				    method :'POST',  
				    headers:{"Content-type": "application/x-www-form-urlencoded; charset=UTF-8"},  
				    body   :urlencode(up),
			    }).then(function (data2) {
			        console.info("returned data for up: ",data2);
			        
			        document.querySelector("div.logfield > label").innerText = "Please wait 4 / 4 ...";
			        document.querySelector("div.info").innerText += "4.) All looks ready... Reloading...\n";
			        //
			        setTimeout(function() {
				        document.location.href=document.location.href;
					},1000);
			    });
		    });
		}
		rd.readAsText(fp.files[0]);
	}
}
function onLoad(e) {
	if( document.location.pathname!="/" || document.location.search!="" ) {
		window.history.replaceState({},"","/");
	}
}
window.onload = function(e) { onLoad(e); }
</script>

<h3><a href="/">Home</a></h3>
<br>
<br>

<div class="logfield">
	<label></label>
	<div class="info"></div>
</div>

Choose arduino control panel: <br>
<form method="POST">
	<input type="file" onchange="loadFile(this);">
</form>

</body>
</html>
