/**
 * (24.9.22)
 * Created by t3ch aka B.K. aka grandekos aka w4d4f4k aka etc..
 * For: ESP32, Arduino, similar.?
 * Useful to control GPIO pins trough WiFi + HTTP server and it configurations.
 * -----
 * Recommented editor usage: Geany + Fold all functions so you see better.
 * Compiling with Arduino IDE..
 * ------
 * G00d luck to all***
 * t3ch
 * */
#include <Arduino.h>
#include <ArduinoJson.h> // https://arduinojson.org/?utm_source=meta&utm_medium=library.properties
#include <GParser.h>     // https://github.com/GyverLibs/GParser
#include "WiFi.h"
#include <Regexp.h>
#include <stdio.h>

//--
// wifi configs.
const char* ssid = "esp32byk0s";
const char* pwd  = "esp32bypwd";
//
IPAddress IP;
// start http server on port 80
WiFiServer server(80);

//--
//
DynamicJsonDocument json_user_panel(4048);
DynamicJsonDocument tasks(4048);
String sson_user_panel = "";
String html_user_panel = "";
// html_start_panel = upload_file_form.html converted with ghexc.php
char html_start_panel[] = 
"\x3c\x68\x74\x6d\x6c\x3e\xa\x3c\x68\x65\x61\x64\x3e\xa\x9\x3c\x6d\x65\x74\x61\x20\x6e\x61\x6d\x65\x3d\x22\x76\x69\x65\x77"
"\x70\x6f\x72\x74\x22\x20\x63\x6f\x6e\x74\x65\x6e\x74\x3d\x22\x77\x69\x64\x74\x68\x3d\x31\x30\x30\x25\x2c\x20\x69\x6e\x69\x74"
"\x69\x61\x6c\x2d\x73\x63\x61\x6c\x65\x3d\x31\x2c\x20\x6d\x61\x78\x69\x6d\x75\x6d\x2d\x73\x63\x61\x6c\x65\x3d\x31\x2c\x20\x6d"
"\x69\x6e\x69\x6d\x75\x6d\x2d\x73\x63\x61\x6c\x65\x3d\x31\x2c\x20\x75\x73\x65\x72\x2d\x73\x63\x61\x6c\x61\x62\x6c\x65\x3d\x6e"
"\x6f\x22\x3e\xa\x9\x3c\x74\x69\x74\x6c\x65\x3e\x55\x70\x6c\x6f\x61\x64\x20\x61\x72\x64\x75\x69\x6e\x6f\x20\x63\x6f\x6e\x74"
"\x72\x6f\x6c\x20\x70\x61\x6e\x65\x6c\x2e\x3c\x2f\x74\x69\x74\x6c\x65\x3e\xa\x3c\x73\x74\x79\x6c\x65\x3e\xa\x2e\x69\x6e\x66"
"\x6f\x7b\x70\x61\x64\x64\x69\x6e\x67\x3a\x31\x33\x70\x78\x3b\x7d\xa\x3c\x2f\x73\x74\x79\x6c\x65\x3e\xa\x3c\x2f\x68\x65\x61"
"\x64\x3e\xa\xa\x3c\x62\x6f\x64\x79\x3e\xa\xa\x3c\x73\x63\x72\x69\x70\x74\x3e\xa\x2f\x2f\xa\x76\x61\x72\x20\x72\x64\x20"
"\x3d\x20\x6e\x75\x6c\x6c\x3b\xa\x2f\x2f\xa\x69\x66\x20\x28\x77\x69\x6e\x64\x6f\x77\x2e\x46\x69\x6c\x65\x20\x26\x26\x20\x77"
"\x69\x6e\x64\x6f\x77\x2e\x46\x69\x6c\x65\x52\x65\x61\x64\x65\x72\x20\x26\x26\x20\x77\x69\x6e\x64\x6f\x77\x2e\x46\x69\x6c\x65"
"\x4c\x69\x73\x74\x20\x26\x26\x20\x77\x69\x6e\x64\x6f\x77\x2e\x42\x6c\x6f\x62\x29\x20\x7b\xa\x9\x72\x64\x20\x3d\x20\x6e\x65"
"\x77\x20\x46\x69\x6c\x65\x52\x65\x61\x64\x65\x72\x28\x29\x3b\xa\x7d\x20\xa\x65\x6c\x73\x65\x20\x7b\xa\x9\x63\x6f\x6e\x73"
"\x6f\x6c\x65\x2e\x77\x61\x72\x6e\x28\x22\x4f\x75\x74\x64\x61\x74\x65\x64\x20\x62\x72\x6f\x77\x73\x65\x72\x21\x22\x29\x3b\xa"
"\x7d\xa\x2f\x2f\xa\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x75\x72\x6c\x65\x6e\x63\x6f\x64\x65\x28\x74\x65\x78\x74\x29\x20\x7b"
"\xa\x20\x20\x20\x20\x76\x61\x72\x20\x74\x6d\x70\x20\x3d\x20\x65\x6e\x63\x6f\x64\x65\x55\x52\x49\x43\x6f\x6d\x70\x6f\x6e\x65"
"\x6e\x74\x28\x20\x74\x65\x78\x74\x20\x29\x3b\xa\x20\x20\x20\x20\x74\x6d\x70\x20\x3d\x20\x74\x6d\x70\x2e\x72\x65\x70\x6c\x61"
"\x63\x65\x28\x6e\x65\x77\x20\x52\x65\x67\x45\x78\x70\x28\x27\x5b\x2a\x5d\x27\x2c\x20\x27\x67\x27\x29\x2c\x20\x27\x25\x32\x41"
"\x27\x29\x3b\xa\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x74\x6d\x70\x3b\xa\x7d\xa\x2f\x2f\xa\x66\x75\x6e\x63\x74\x69"
"\x6f\x6e\x20\x6c\x6f\x61\x64\x46\x69\x6c\x65\x28\x66\x70\x29\x20\x7b\xa\x9\x63\x6f\x6e\x73\x6f\x6c\x65\x2e\x69\x6e\x66\x6f"
"\x28\x22\x6c\x6f\x61\x64\x46\x69\x6c\x65\x28\x29\x20\x73\x74\x61\x72\x74\x65\x64\x2e\x2e\x2e\x22\x2c\x66\x70\x29\x3b\xa\x9"
"\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x6c\x6f\x67"
"\x66\x69\x65\x6c\x64\x20\x3e\x20\x6c\x61\x62\x65\x6c\x22\x29\x2e\x69\x6e\x6e\x65\x72\x54\x65\x78\x74\x20\x3d\x20\x22\x50\x6c"
"\x65\x61\x73\x65\x20\x77\x61\x69\x74\x20\x31\x20\x2f\x20\x34\x20\x2e\x2e\x2e\x22\x3b\xa\x9\x76\x61\x72\x20\x6f\x75\x74\x3d"
"\x6e\x75\x6c\x6c\x3b\xa\x9\x69\x66\x28\x72\x64\x21\x3d\x6e\x75\x6c\x6c\x20\x26\x26\x20\x66\x70\x2e\x66\x69\x6c\x65\x73\x20"
"\x26\x26\x20\x66\x70\x2e\x66\x69\x6c\x65\x73\x5b\x30\x5d\x29\x20\x7b\xa\x9\x9\x72\x64\x2e\x6f\x6e\x6c\x6f\x61\x64\x20\x3d"
"\x20\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x65\x29\x20\x7b\xa\x9\x9\x9\x6f\x75\x74\x20\x3d\x20\x65\x2e\x74\x61\x72\x67\x65"
"\x74\x2e\x72\x65\x73\x75\x6c\x74\x3b\xa\x9\x9\x9\x63\x6f\x6e\x73\x6f\x6c\x65\x2e\x69\x6e\x66\x6f\x28\x22\x47\x6f\x74\x20"
"\x66\x69\x6c\x65\x3a\x20\x22\x2c\x6f\x75\x74\x29\x3b\xa\x9\x9\x9\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x71\x75\x65\x72\x79"
"\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x69\x6e\x66\x6f\x22\x29\x2e\x69\x6e\x6e\x65\x72\x54\x65\x78\x74\x20"
"\x2b\x3d\x20\x22\x31\x2e\x29\x20\x47\x6f\x74\x20\x66\x69\x6c\x65\x2c\x20\x73\x69\x7a\x65\x3a\x20\x22\x2b\x6f\x75\x74\x2e\x6c"
"\x65\x6e\x67\x74\x68\x2b\x22\x5c\x6e\x22\x3b\xa\x9\x9\x9\x2f\x2f\xa\x9\x20\x20\x20\x20\x20\x20\x20\x20\x69\x66\x28\x21"
"\x6f\x75\x74\x2e\x6d\x61\x74\x63\x68\x28\x2f\x2e\x2a\x5c\x3c\x5c\x2f\x61\x72\x64\x75\x69\x6e\x6f\x5c\x3e\x2e\x2a\x2f\x69\x29"
"\x29\x20\x7b\xa\x9\x9\x9\x9\x61\x6c\x65\x72\x74\x28\x22\x43\x6f\x6e\x74\x72\x6f\x6c\x20\x70\x61\x6e\x65\x6c\x20\x73\x68"
"\x6f\x75\x6c\x64\x20\x63\x6f\x6e\x74\x61\x69\x6e\x20\x61\x72\x64\x75\x69\x6e\x6f\x20\x63\x6f\x6e\x66\x69\x67\x75\x72\x61\x74"
"\x69\x6f\x6e\x20\x69\x6e\x20\x4a\x53\x4f\x4e\x20\x66\x6f\x72\x6d\x61\x74\x20\x61\x6e\x64\x20\x69\x6e\x73\x69\x64\x65\x20\x6f"
"\x66\x20\x3c\x61\x72\x64\x75\x69\x6e\x6f\x3e\x28\x6a\x73\x6f\x6e\x29\x3c\x2f\x61\x72\x64\x75\x69\x6e\x6f\x3e\x20\x68\x74\x6d"
"\x6c\x20\x62\x6c\x6f\x63\x6b\x2e\x22\x29\x3b\xa\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e"
"\x6c\x6f\x63\x61\x74\x69\x6f\x6e\x2e\x68\x72\x65\x66\x3d\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x6c\x6f\x63\x61\x74\x69\x6f\x6e"
"\x2e\x68\x72\x65\x66\x3b\xa\x9\x9\x9\x9\x72\x65\x74\x75\x72\x6e\x20\x66\x61\x6c\x73\x65\x3b\xa\x9\x9\x9\x7d\xa\x9"
"\x9\x9\xa\x9\x9\x9\x2f\x2f\xa\x9\x9\x9\x76\x61\x72\x20\x61\x74\x6d\x70\x3d\x6f\x75\x74\x2e\x73\x70\x6c\x69\x74\x28"
"\x22\x3c\x5c\x2f\x61\x72\x64\x75\x69\x6e\x6f\x5c\x3e\x22\x29\x3b\xa\x9\x9\x9\x69\x66\x28\x20\x61\x74\x6d\x70\x2e\x6c\x65"
"\x6e\x67\x74\x68\x21\x3d\x32\x20\x29\x20\x7b\xa\x9\x9\x9\x9\x61\x6c\x65\x72\x74\x28\x22\x53\x6f\x6d\x65\x74\x68\x69\x6e"
"\x67\x20\x77\x65\x6e\x74\x20\x77\x72\x6f\x6e\x67\x2e\x20\x41\x66\x74\x65\x72\x20\x70\x61\x72\x73\x69\x6e\x67\x20\x61\x72\x72"
"\x61\x79\x20\x73\x68\x6f\x75\x6c\x64\x20\x63\x6f\x6e\x74\x61\x69\x6e\x20\x32\x20\x76\x61\x6c\x75\x65\x73\x20\x62\x75\x74\x20"
"\x74\x68\x65\x72\x65\x20\x61\x72\x65\x20\x22\x2b\x61\x74\x6d\x70\x2e\x6c\x65\x6e\x67\x74\x68\x29\x3b\xa\x9\x9\x9\x9\x64"
"\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x6c\x6f\x63\x61\x74\x69\x6f\x6e\x2e\x68\x72\x65\x66\x3d\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e"
"\x6c\x6f\x63\x61\x74\x69\x6f\x6e\x2e\x68\x72\x65\x66\x3b\xa\x9\x9\x9\x9\x72\x65\x74\x75\x72\x6e\x20\x66\x61\x6c\x73\x65"
"\x3b\xa\x9\x9\x9\x7d\xa\x9\x9\x9\xa\x9\x9\x9\x76\x61\x72\x20\x75\x70\x63\x20\x3d\x20\x61\x74\x6d\x70\x5b\x30\x5d"
"\x2e\x73\x75\x62\x73\x74\x72\x28\x39\x2c\x61\x74\x6d\x70\x5b\x30\x5d\x2e\x6c\x65\x6e\x67\x74\x68\x29\x3b\xa\x9\x9\x9\x76"
"\x61\x72\x20\x75\x70\x20\x20\x3d\x20\x61\x74\x6d\x70\x5b\x31\x5d\x3b\xa\x9\x9\x9\xa\x9\x9\x9\x64\x6f\x63\x75\x6d\x65"
"\x6e\x74\x2e\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x6c\x6f\x67\x66\x69\x65\x6c\x64\x20"
"\x3e\x20\x6c\x61\x62\x65\x6c\x22\x29\x2e\x69\x6e\x6e\x65\x72\x54\x65\x78\x74\x20\x3d\x20\x22\x50\x6c\x65\x61\x73\x65\x20\x77"
"\x61\x69\x74\x20\x32\x20\x2f\x20\x34\x20\x2e\x2e\x2e\x22\x3b\xa\x9\x9\x9\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x71\x75\x65"
"\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x69\x6e\x66\x6f\x22\x29\x2e\x69\x6e\x6e\x65\x72\x54\x65\x78"
"\x74\x20\x2b\x3d\x20\x22\x32\x2e\x29\x20\x53\x75\x63\x63\x65\x73\x73\x66\x75\x6c\x20\x70\x61\x72\x73\x69\x6e\x67\x20\x75\x70"
"\x6c\x6f\x61\x64\x65\x64\x20\x66\x69\x6c\x65\x5c\x6e\x22\x3b\xa\x9\x9\x9\xa\x9\x9\x9\x2f\x2f\xa\x9\x9\x9\x72\x65"
"\x74\x75\x72\x6e\x20\x66\x65\x74\x63\x68\x28\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x6c\x6f\x63\x61\x74\x69\x6f\x6e\x2e\x6f\x72"
"\x69\x67\x69\x6e\x2c\x20\x7b\x20\x20\xa\x9\x9\x9\x20\x20\x20\x20\x6d\x65\x74\x68\x6f\x64\x20\x3a\x27\x50\x4f\x53\x54\x27"
"\x2c\x20\x20\xa\x9\x9\x9\x20\x20\x20\x20\x68\x65\x61\x64\x65\x72\x73\x3a\x7b\x22\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x74\x79"
"\x70\x65\x22\x3a\x20\x22\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x78\x2d\x77\x77\x77\x2d\x66\x6f\x72\x6d\x2d\x75\x72"
"\x6c\x65\x6e\x63\x6f\x64\x65\x64\x3b\x20\x63\x68\x61\x72\x73\x65\x74\x3d\x55\x54\x46\x2d\x38\x22\x7d\x2c\x20\x20\xa\x9\x9"
"\x9\x20\x20\x20\x20\x62\x6f\x64\x79\x20\x20\x20\x3a\x22\x75\x70\x63\x3d\x22\x2b\x75\x72\x6c\x65\x6e\x63\x6f\x64\x65\x28\x75"
"\x70\x63\x29\x2c\xa\x9\x9\x20\x20\x20\x20\x7d\x29\x2e\x74\x68\x65\x6e\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20\x28\x64\x61"
"\x74\x61\x31\x29\x20\x7b\xa\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x63\x6f\x6e\x73\x6f\x6c\x65\x2e\x69\x6e\x66\x6f\x28\x22"
"\x72\x65\x74\x75\x72\x6e\x65\x64\x20\x64\x61\x74\x61\x20\x66\x6f\x72\x20\x75\x70\x63\x3a\x20\x22\x2c\x64\x61\x74\x61\x31\x29"
"\x3b\xa\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\xa\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74"
"\x2e\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x6c\x6f\x67\x66\x69\x65\x6c\x64\x20\x3e\x20"
"\x6c\x61\x62\x65\x6c\x22\x29\x2e\x69\x6e\x6e\x65\x72\x54\x65\x78\x74\x20\x3d\x20\x22\x50\x6c\x65\x61\x73\x65\x20\x77\x61\x69"
"\x74\x20\x33\x20\x2f\x20\x34\x20\x2e\x2e\x2e\x22\x3b\xa\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x64\x6f\x63\x75\x6d\x65\x6e"
"\x74\x2e\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x69\x6e\x66\x6f\x22\x29\x2e\x69\x6e\x6e"
"\x65\x72\x54\x65\x78\x74\x20\x2b\x3d\x20\x22\x33\x2e\x29\x20\x43\x6f\x6e\x66\x69\x67\x75\x72\x61\x74\x69\x6f\x6e\x20\x6c\x6f"
"\x6f\x6b\x73\x20\x67\x6f\x6f\x64\x5c\x6e\x22\x3b\xa\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x2f\x2f\xa\x9\x9\x9\x9\x72"
"\x65\x74\x75\x72\x6e\x20\x66\x65\x74\x63\x68\x28\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x6c\x6f\x63\x61\x74\x69\x6f\x6e\x2e\x6f"
"\x72\x69\x67\x69\x6e\x2c\x20\x7b\x20\x20\xa\x9\x9\x9\x9\x20\x20\x20\x20\x6d\x65\x74\x68\x6f\x64\x20\x3a\x27\x50\x4f\x53"
"\x54\x27\x2c\x20\x20\xa\x9\x9\x9\x9\x20\x20\x20\x20\x68\x65\x61\x64\x65\x72\x73\x3a\x7b\x22\x43\x6f\x6e\x74\x65\x6e\x74"
"\x2d\x74\x79\x70\x65\x22\x3a\x20\x22\x61\x70\x70\x6c\x69\x63\x61\x74\x69\x6f\x6e\x2f\x78\x2d\x77\x77\x77\x2d\x66\x6f\x72\x6d"
"\x2d\x75\x72\x6c\x65\x6e\x63\x6f\x64\x65\x64\x3b\x20\x63\x68\x61\x72\x73\x65\x74\x3d\x55\x54\x46\x2d\x38\x22\x7d\x2c\x20\x20"
"\xa\x9\x9\x9\x9\x20\x20\x20\x20\x62\x6f\x64\x79\x20\x20\x20\x3a\x22\x75\x70\x3d\x22\x2b\x75\x72\x6c\x65\x6e\x63\x6f\x64"
"\x65\x28\x75\x70\x29\x2c\xa\x9\x9\x9\x20\x20\x20\x20\x7d\x29\x2e\x74\x68\x65\x6e\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20"
"\x28\x64\x61\x74\x61\x32\x29\x20\x7b\xa\x9\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x63\x6f\x6e\x73\x6f\x6c\x65\x2e\x69\x6e"
"\x66\x6f\x28\x22\x72\x65\x74\x75\x72\x6e\x65\x64\x20\x64\x61\x74\x61\x20\x66\x6f\x72\x20\x75\x70\x3a\x20\x22\x2c\x64\x61\x74"
"\x61\x32\x29\x3b\xa\x9\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\xa\x9\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x64\x6f\x63"
"\x75\x6d\x65\x6e\x74\x2e\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x6c\x6f\x67\x66\x69\x65"
"\x6c\x64\x20\x3e\x20\x6c\x61\x62\x65\x6c\x22\x29\x2e\x69\x6e\x6e\x65\x72\x54\x65\x78\x74\x20\x3d\x20\x22\x50\x6c\x65\x61\x73"
"\x65\x20\x77\x61\x69\x74\x20\x34\x20\x2f\x20\x34\x20\x2e\x2e\x2e\x22\x3b\xa\x9\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x64"
"\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x71\x75\x65\x72\x79\x53\x65\x6c\x65\x63\x74\x6f\x72\x28\x22\x64\x69\x76\x2e\x69\x6e\x66\x6f"
"\x22\x29\x2e\x69\x6e\x6e\x65\x72\x54\x65\x78\x74\x20\x2b\x3d\x20\x22\x34\x2e\x29\x20\x41\x6c\x6c\x20\x6c\x6f\x6f\x6b\x73\x20"
"\x72\x65\x61\x64\x79\x2e\x2e\x2e\x20\x52\x65\x6c\x6f\x61\x64\x69\x6e\x67\x2e\x2e\x2e\x5c\x6e\x22\x3b\xa\x9\x9\x9\x20\x20"
"\x20\x20\x20\x20\x20\x20\x2f\x2f\xa\x9\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x73\x65\x74\x54\x69\x6d\x65\x6f\x75\x74\x28"
"\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x20\x7b\xa\x9\x9\x9\x9\x20\x20\x20\x20\x20\x20\x20\x20\x64\x6f\x63\x75\x6d\x65"
"\x6e\x74\x2e\x6c\x6f\x63\x61\x74\x69\x6f\x6e\x2e\x68\x72\x65\x66\x3d\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x6c\x6f\x63\x61\x74"
"\x69\x6f\x6e\x2e\x68\x72\x65\x66\x3b\xa\x9\x9\x9\x9\x9\x7d\x2c\x31\x30\x30\x30\x29\x3b\xa\x9\x9\x9\x20\x20\x20\x20"
"\x7d\x29\x3b\xa\x9\x9\x20\x20\x20\x20\x7d\x29\x3b\xa\x9\x9\x7d\xa\x9\x9\x72\x64\x2e\x72\x65\x61\x64\x41\x73\x54\x65"
"\x78\x74\x28\x66\x70\x2e\x66\x69\x6c\x65\x73\x5b\x30\x5d\x29\x3b\xa\x9\x7d\xa\x7d\xa\x66\x75\x6e\x63\x74\x69\x6f\x6e\x20"
"\x6f\x6e\x4c\x6f\x61\x64\x28\x65\x29\x20\x7b\xa\x9\x69\x66\x28\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x6c\x6f\x63\x61\x74"
"\x69\x6f\x6e\x2e\x70\x61\x74\x68\x6e\x61\x6d\x65\x21\x3d\x22\x2f\x22\x20\x7c\x7c\x20\x64\x6f\x63\x75\x6d\x65\x6e\x74\x2e\x6c"
"\x6f\x63\x61\x74\x69\x6f\x6e\x2e\x73\x65\x61\x72\x63\x68\x21\x3d\x22\x22\x20\x29\x20\x7b\xa\x9\x9\x77\x69\x6e\x64\x6f\x77"
"\x2e\x68\x69\x73\x74\x6f\x72\x79\x2e\x72\x65\x70\x6c\x61\x63\x65\x53\x74\x61\x74\x65\x28\x7b\x7d\x2c\x22\x22\x2c\x22\x2f\x22"
"\x29\x3b\xa\x9\x7d\xa\x7d\xa\x77\x69\x6e\x64\x6f\x77\x2e\x6f\x6e\x6c\x6f\x61\x64\x20\x3d\x20\x66\x75\x6e\x63\x74\x69\x6f"
"\x6e\x28\x65\x29\x20\x7b\x20\x6f\x6e\x4c\x6f\x61\x64\x28\x65\x29\x3b\x20\x7d\xa\x3c\x2f\x73\x63\x72\x69\x70\x74\x3e\xa\xa"
"\x3c\x68\x33\x3e\x3c\x61\x20\x68\x72\x65\x66\x3d\x22\x2f\x22\x3e\x48\x6f\x6d\x65\x3c\x2f\x61\x3e\x3c\x2f\x68\x33\x3e\xa\x3c"
"\x62\x72\x3e\xa\x3c\x62\x72\x3e\xa\xa\x3c\x64\x69\x76\x20\x63\x6c\x61\x73\x73\x3d\x22\x6c\x6f\x67\x66\x69\x65\x6c\x64\x22"
"\x3e\xa\x9\x3c\x6c\x61\x62\x65\x6c\x3e\x3c\x2f\x6c\x61\x62\x65\x6c\x3e\xa\x9\x3c\x64\x69\x76\x20\x63\x6c\x61\x73\x73\x3d"
"\x22\x69\x6e\x66\x6f\x22\x3e\x3c\x2f\x64\x69\x76\x3e\xa\x3c\x2f\x64\x69\x76\x3e\xa\xa\x43\x68\x6f\x6f\x73\x65\x20\x61\x72"
"\x64\x75\x69\x6e\x6f\x20\x63\x6f\x6e\x74\x72\x6f\x6c\x20\x70\x61\x6e\x65\x6c\x3a\x20\x3c\x62\x72\x3e\xa\x3c\x66\x6f\x72\x6d"
"\x20\x6d\x65\x74\x68\x6f\x64\x3d\x22\x50\x4f\x53\x54\x22\x3e\xa\x9\x3c\x69\x6e\x70\x75\x74\x20\x74\x79\x70\x65\x3d\x22\x66"
"\x69\x6c\x65\x22\x20\x6f\x6e\x63\x68\x61\x6e\x67\x65\x3d\x22\x6c\x6f\x61\x64\x46\x69\x6c\x65\x28\x74\x68\x69\x73\x29\x3b\x22"
"\x3e\xa\x3c\x2f\x66\x6f\x72\x6d\x3e\xa\xa\x3c\x2f\x62\x6f\x64\x79\x3e\xa\x3c\x2f\x68\x74\x6d\x6c\x3e\xa";



//--
// MISSING C FUNCTIonS START
//---------------------------
int match(char *string, char *pattern);
char ** split(const char * str, const char * delim);
void substring(const char s[], char sub[], int p, int l);
char* str_replace(const char* s, const char* oldW, const char* newW);
char *strstrip(char *s);
void phex(const char* s);
char * c2c(const char *from);





//--
// Program functions START
//---------------------------
//
void htmlHeader(WiFiClient cli, int code) {
    char * tmp = (char*)malloc(56);
    sprintf(tmp,"HTTP/1.1 %i OK", code);
    
    //cli.println("HTTP/1.1 200 OK");
    cli.println( tmp );
    cli.println("Content-type: text/html");
    cli.println("Connection: close");
    cli.println("");
}
//
void htmlDocument(WiFiClient cli, String html) {
    cli.println( html );
}





//--
// Default Arduino functions START
//---------------------------------
void setup() {
    //--
    Serial.begin(115200);
    //
    WiFi.mode(WIFI_AP);
    WiFi.softAP(ssid, pwd);
    IP = WiFi.softAPIP(); //lol :) all is lol so if this is c then.. owyea! :)
    //--
    //
    Serial.println("Hello, world...");
    Serial.println(IP);
    //
    server.begin();
}

void loop() {
    //
    WiFiClient cli = server.available();
    //
    if( cli ) {
        //
        char** cmd;
        String cmdline   = "";
        String type      = ""; // Content-Type..: application/x-www-form-urlencoded,
        String length    = ""; // Content-Length..: 9999 (useful to know if body is included or not. i hope.) :)
        String line      = "";
        String head      = "";
        String body      = "";
        boolean headDone = false;
        
        //
        while( cli.connected() ) {
            // Connect
            if( cli.available() ) {
                //
                line = cli.readStringUntil('\r');
                //--
                // Strip bad characters \r. Lets hope there is nothing else.. :)
                if( line.length()>3 && match(c2c(line.c_str()),"^\xa.*")==1 ) {
                    Serial.println("Fixing line...");
                    char * tmpline = (char*)malloc(line.length()+1);
                    substring(line.c_str(),tmpline,2,line.length());
                    line = tmpline;
                    free(tmpline);
                }
                
                //--
                // Finish Retriving Header
                // Here we know if we should continue retrive body or finish request with response.
                //
                if( !headDone && line=="\xa" ) {
                    Serial.println("DEBUG HEADER END.");
                    headDone = true;
                    
                    // Content-Length Not Set
                    if( length=="" ) {
                        Serial.println("Breaking request. (d1)");
                        break;
                    }
                    // Content-Length is Set, continue retriving body
                    else {
                        Serial.println("Continue request with retrive of body. (d2)");
                    }
                }
                // retrive header & parse header values
                else if(!headDone) {
                    Serial.println("Appending HEADER.");
                    //Serial.println(line);
                    
                    head += line+"\n";
                    
                    // parse header command / option
                    if( match(c2c(line.c_str()),"^GET.*")==1 ||
                        match(c2c(line.c_str()),"^POST.*")==1 ) {
                        //
                        Serial.println("DEBUG CMD LINE");
                        //
                        line    = str_replace(line.c_str(),"  "," "); // fix double space for one
                        cmdline = line;
                        cmd     = split( line.c_str(), " " );
                    }
                    // parse Content-Type
                    else if( match(c2c(line.c_str()),"^Content.Type.*")==1 ) {
                        Serial.println("DEBUG CMD Content-Type LINE");
                        //
                        char ** tmp = split(line.c_str(),": ");
                        type = tmp[1];
                    }
                    // parse Content-Length
                    else if( match(c2c(line.c_str()),"^Content.Length.*")==1 ) {
                        Serial.println("DEBUG CMD Content-Type LINE");
                        //
                        char ** tmp = split(line.c_str(),": ");
                        length = tmp[1];
                    }
                }
                // body end
                else if( headDone && line=="\xa" ) {
                    Serial.println("DEBUG BODY END.");
                    break;
                }
                // retrive body
                else {
                    Serial.println("DEBUG BODY ADD.. length vs body.length: ");
                    Serial.println(line);
                    body += line+"\n";
                    
                    char *tmp = (char*)malloc(128);
                    sprintf(tmp,"DEBUG BODY ADD/END? body.length: %i vs length: %i\n",body.length(), strtol(length.c_str(), NULL, 2));
                    Serial.println(tmp);
                    
                    //if( length!="" && body.length() >= atoi(length.c_str()) ) {
                    if( body.length() >= strtol(length.c_str(), NULL, 2) ) {
                        Serial.println("DEBUG BODY ADD/ENDING...!");
                        break;
                    }
                }
            }
            // Disconnect
            else {
                //
                Serial.println("DEBUG Cli no more available!");
                //
                //cli.stop();
                //cli.flush();
                //
                //delay(1000);
                //
                break;
            }
        }
        
        //--
        // Parse and handle commands
        //-------------------
        // Uploading new command panel
        if( match(c2c(body.c_str()),"^up\=.*")==1 ) {
            Serial.println("DEBUG parsing new panel..");
            //
            char * tmp_panel = (char*)malloc(body.length()+1);
            substring(body.c_str(),tmp_panel,4,body.length());
            html_user_panel = GP_urldecode( tmp_panel );
            free( tmp_panel );
        }
        // Uploading new configurations for panel
        else if( match(c2c(body.c_str()),"^upc\=.*")==1 ) {
            Serial.println("DEBUG parsing new panel configuration..");
            //
            char * tmp_confs = (char*)malloc(body.length()+1);
            substring(body.c_str(),tmp_confs,5,body.length());
            sson_user_panel = GP_urldecode( tmp_confs );
            
            deserializeJson(json_user_panel, sson_user_panel);
            tasks = json_user_panel["tasks"];
            
            free( tmp_confs );
        }
        // Reset uploaded panel
        else if( match(cmd[1], "^\/reset+$")==1 ) {
            Serial.println("DEBUG reseting to start_panel...");
            html_user_panel = "";
        }
        
        //--
        // Handle JSON Configured commands
        //---------------------------------
        // Loop trough json configured tasks and check if request match 
        for(int i=0; i<tasks.size(); i++) {
            String taskTitle   = tasks[i]["title"];
            String taskRequest = tasks[i]["request"];
            DynamicJsonDocument actions(1024);
            actions            = tasks[i]["actions"];
            
            Serial.println("taskTitle: ");
            Serial.println(taskTitle);
            Serial.println("taskRequest: ");
            Serial.println(taskRequest);
            
            // Request match for action!
            if( match(cmd[1],c2c(taskRequest.c_str()))==1 ) {
                Serial.println("DEBUG CORRECT TASK REQUEST!!! Firing!!! Num actions: ");
                Serial.println(actions.size());
                // Loop trough request actions and exec them..
                for(int j=0; j<actions.size(); j++) {
                    Serial.println("Entering action...");
                    // Ex. action: {"gpio":27,"value":0,"type":"DW"}
                    // value 0 = LOW, 1=HIGH
                    // todo DW = digitalWrite, DR = digitalRead, AW = analogWrite, AR = analogRead
                    int gpio         = actions[j]["gpio"];
                    int value        = actions[j]["value"];
                    String type      = actions[j]["type"];
                    Serial.println(gpio);
                    Serial.println(value);
                    Serial.println(type);
                    //
                    if( type=="DW" ) {
                        Serial.println("DEBUG FIRING DW!");
                        if( actions[j]["initialized"]==0 ) {
                            actions[j]["initialized"] = 1;
                            pinMode(gpio,OUTPUT);
                        }
                        digitalWrite( gpio, value );
                    }
                    //
                    else if( type=="AW" ) {
                        Serial.println("DEBUG FIRING AW!");
                        if( actions[j]["initialized"]==0 ) {
                            actions[j]["initialized"] = 1;
                            pinMode(gpio,OUTPUT);
                        }
                        analogWrite( gpio, value );
                        //ledcWrite(gpio, value);
                    }
                    else {
                        Serial.println("DEBUG NOT CORRECT TYPE...");
                    }
                }
            }
        }
        
        //--
        // Handle response
        //-------------------
        //
        htmlHeader(cli,200);
        //
        htmlDocument(cli,(html_user_panel!=""?html_user_panel:html_start_panel));
        
        //
        //
        for(int i=0; cmd[i]!=NULL; i++) {
            Serial.println("cmd[x]: ");
            Serial.println(cmd[i]);
        }
        //
        Serial.println("cmdline: ");
        Serial.println(cmdline);
        Serial.println("content type: ");
        Serial.println(type);
        Serial.println("content length: ");
        Serial.println(length);
        Serial.println("head.len: ");
        Serial.println( head.length() );
        Serial.println("body.len: ");
        Serial.println( body.length() );
        //Serial.println( body );
        //Serial.println("html_user_panel: ");
        //Serial.println( html_user_panel );
        //Serial.println("sson_user_panel: ");
        //Serial.println( sson_user_panel );
        //
        cli.stop();
        cli.flush();
    }

    Serial.println("outloop...");
    delay(1500);
}



//--
// Missing and Useful C Functions START
//--------------------------------------
/**
 * Match string against the extended regular expression in
 * pattern, treating errors as no match.
 *
 * return 1 for match, 0 for no match
 */
int match(char *string, char *pattern) {
    MatchState ms;
    ms.Target( string );
    char result = ms.Match( pattern );
    if (result>0) {
        return(1);
    }
    return(0);
}

/**
 * function split() taken from: 
 * https://stackoverflow.com/questions/54261257/splitting-a-string-and-returning-an-array-of-strings
 * Fixed by t3ch for arduino.
 * */
char ** split(const char * str, const char * delim) {
  /* count words */
  char * s = strdup(str);
  
  if (strtok(s, delim) == 0)
  /* no word */
  return NULL;
  
  int nw = 1;
  
  while (strtok(NULL, delim) != 0)
  nw += 1;
  
  strcpy(s, str); /* restore initial string modified by strtok */
  
  /* split */
  //char ** v = malloc((nw + 1) * sizeof(char *));
  char ** v = (char**)malloc((nw + 1) * sizeof(char *));
  int i;
  
  v[0] = strdup(strtok(s, delim));
  
  for (i = 1; i != nw; ++i)
  v[i] = strdup(strtok(NULL, delim));
  
  v[i] = NULL; /* end mark */
  
  free(s);
  
  return v;
}

/**
 * Reference by: https://www.geeksforgeeks.org/c-program-replace-word-text-another-given-word/
 * */
char* str_replace(const char* s, const char* oldW, const char* newW) {
    char* result;
    int i, cnt = 0;
    int newWlen = strlen(newW);
    int oldWlen = strlen(oldW);
 
    // Counting the number of times old word
    // occur in the string
    for (i = 0; s[i] != '\0'; i++) {
        if (strstr(&s[i], oldW) == &s[i]) {
            cnt++;
 
            // Jumping to index after the old word.
            i += oldWlen - 1;
        }
    }
 
    // Making new string of enough length
    result = (char*)malloc(i + cnt * (newWlen - oldWlen) + 1);
 
    i = 0;
    while (*s) {
        // compare the substring with the result
        if (strstr(s, oldW) == s) {
            strcpy(&result[i], newW);
            i += newWlen;
            s += oldWlen;
        }
        else
            result[i++] = *s++;
    }
 
    result[i] = '\0';
    return result;
}

/***/
char *strstrip(char *s) {
        size_t size;
        char *end;

        size = strlen(s);

        if (!size)
                return s;

        end = s + size - 1;
        while (end >= s && isspace(*end))
                end--;
        *(end + 1) = '\0';

        while (*s && isspace(*s))
                s++;

        return s;
}

/**
// substring(...)
// C substring function definition
// p=1...X
// l=strlen(s)
// Ex: substring(tmp1, tmp2, 2, strlen(tmp1));
*/
void substring(const char s[], char sub[], int p, int l) {
   int c = 0;
   
   while (c < l) {
      sub[c] = s[p+c-1];
      c++;
   }
   sub[c] = '\0';
}

/*void swap(String **a, String **b) {
  String * t = *a;
  *a = *b;
  *b = t;
}*/

//
void phex(const char* s) {
  //
  //printf("DEBUG 1\n");
  char* tmp = (char*)malloc(128);
  for(int i=0; i<strlen(s); i++) {
    int x = (int)s[i];
    sprintf(tmp,"%s%x",tmp,x);
  }
  Serial.println( tmp );
}

//
char * c2c(const char *from) {
    char  *ret = (char*)malloc(strlen(from)+1);
    //char ret[strlen(from)+1];
    strcpy(ret, from);
    return ret;
}
